import re
from collections import OrderedDict
from nltk.stem import WordNetLemmatizer

wnl = WordNetLemmatizer();
desc = "Description\n Files 1\n Install Instructions\n All Comments 6\n\n\n\n\n\n\n\n\nHello S4 Modlings! I present to you my first upload: Tense Sense!\n\nThis Trait adds 4 unique moodlets which will both challenge and benefit affected Sims. They will randomly gain two powerful negative Moodlets, Tense Stress and Tense Anger, the former more frequently than the latter. If near Sims with which their Friendship is below 60% and Romance is below 30%, the Sim will gain Don't Want To Deal With Them, a powerful negative Moodlet. While in a neutral or positive Mood and free of the aforesaid Moodlets, Sims will gain a very powerful neutral Moodlet, Peace Of Mind.\n\nDue to their cumbersome social difficulties, they have no actual need for social interactions; their Social Need bar will never decrease. There are many other nit-picky details I've attached to all three Moodlets, viewable in the spoilers below.\n\n\n\n\nTense Stress\nTense +4, 2.5 hour duration.75% chance at 6-18 hour intervals.50% base chance on Moodlet addition to decrease Manners by 10, chance increased based on Trait Moodlets and negative Mood.While active:(Parenthood) All five Life Skills will decrease 25% more per interaction.Creative Skills increase 25% slower and are 1 rank less effective. (A skill at rank 6 will act as though it is rank 5)Mental Skills increase 30% slower and are 2 ranks less effective.Social Skills increase 50% slower and are 1 rank less effective.Musical Skills increase 20% slower and are 1 rank less effective.Physical and Athletic Skills increase 10% faster and are 1 rank more effective.Fun Need decays 10% faster.Hygiene Need decays 5% faster.Friendship will increase 10% slower and decrease 10% faster per interaction.Romance will increase 15% slower and decrease 15% faster per interaction.(Parenthood) Authority and Rivalry will increase 10% slower and decrease 10% faster per interaction.Sims are more likely to use Angry or negative autonomy interactions.\n\n\n\n\n\nTense Anger\nAngry +3, 2.5 hour duration.50% chance at 12-24 hour intervals.(Parenthood) 25% base chance on Moodlet addition to decrease Emotional Control by 10, chance increased based on Trait Moodlets and negative Mood.While active:(Parenthood) All five Life Skills will decrease 25% more per interaction.Creative Skills increase 25% slower and are 2 ranks less effective.Mental Skills increase 30% slower and are 2 ranks less effective.Social Skills increase 50% slower and are 2 ranks less effective.Musical Skills increase 20% slower and are 1 rank less effective.Physical and Athletic Skills increase 10% faster and are 2 ranks more effective.Fun Need decays 10% faster.Hygiene Need decays 5% faster.Friendship will increase 10% slower and decrease 10% faster per interaction.Romance will increase 15% slower and decrease 15% faster per interaction.(Parenthood) Authority and Rivalry will increase 10% slower and decrease 10% faster per interaction.Sims are more likely to use Angry or negative autonomy interactions.\n\n\n\n\n\nDon't Want To Deal With Them\n \n\nWhile Active:Proximity Buff; will activate when near any Sim(s) with less than 60% Friendship OR 30% Romance that is not part of your household.Continuous Staged Buff; Moodlet duration will continue to increase as long as you are in range of triggering Sims.60 minute grace period before triggering and adding the Moodlet, but Moodlet will persist until timer expires.If the Sim gets back in range of a trigger Sim, Moodlet will continue increasing again instantly. (No grace period until expiration)Moodlet has 9 Stages, each one Sim-hour; Moodlet increases 33% faster than it decreases. (40 Sim-minutes per Stage when increasing)Each Stage makes the Moodlet more intense; from Tense +1 to +6, then changes to Angry +4, +7, and finally +10.The Moodlet will stage downward, too! Each stage lasts 60 Sim-minutes, but is affected by anti-Tense interactions.Fun Need decays 10% faster.\n\n\n\n\n\nPeace Of Mind\nFine +3, Active Buff. Moodlet will appear any time the Sim is in a neutral/positive mood AND does not have any Trait debuff Moodlets.While Active:Increases Focused-Mood-based Careers' Performance gains by 50%.(Get To Work) Increases Scientist Breakthrough Progress gain by 33%.(Get To Work) Increases Detective Interrogation Table Progress gain by 25%.(Parenthood) Increases Life Skills gains by 33%.Increases all Mental Skill gains by ~17-33%.(Get Together) Increases Fitness and Dancing Skill gains by ~8%.(Cats & Dogs, Vampires)Increases Pet Training and Vampire Lore Skill gains by ~17%.(Get To Work) Increases Retail Skill gains by 25%.Increases Hack Payout and Homework gains by ~17%.Increases Crafting Progress gains by 25%.(Cats & Dogs) Increases Discipline gains by 25%.Increases all Programming crafts progress gains by 25%.Increases Horseshoes and Video Games' Skills by ~17%.Increases Woodwork Progress gain by 25%.\n\n\nAdditional Credits:\nThanks are almost entirely to:\n\nZerbu's Mod Constructor\nSims 4 Studio\ns4pe\n\n\n\n\n\nKey:  - File was updated after upload was posted\n\n\n\n\nFilename - Tip: You can click the magnifying glass to see the archive contents\nSize\nDownloads\nDate\n\n\n\n\n\n\n\n\n\nKarazhan87_TenseTrait.7z\n| Description: Sims with the Tense Sense trait have a Tense personality! They will become Tense and/or Angry at random intervals, but benefit from a clear mind.\n\n\n22.2 KB\n1,285\n23rd Jan 2018 \n\n\n\n\n\n17\nThanks\n\nSay Thanks\n\n\n\nNeed help with downloading or installing content? Click this link!\n\n\n\n\n\n\n\n\n Basic Download and Install Instructions:1. Download: Click the File tab to see the download link. Click the link to save the .rar or .zip file(s) to your computer. Read the upload description for installation instructions. If nothing else is specified, do the following:  No Extraction Required (Script Mods):1. Cut and paste the .zip file(s) into your Mods folderWindows XP: Documents and Settings\\(Current User Account)\\My Documents\\Electronic Arts\\The Sims 4\\Mods\\Windows Vista/7/8/8.1: Users\\(Current User Account)\\Documents\\Electronic Arts\\The Sims 4\\Mods\\Script mods need to be placed directly in \\Mods or one level below that (e.g. \\Mods\\Scripts)  sub-folders nested any deeper wont work.\n  Extraction Required (Everything Else):1. Use WinRAR (Windows) to extract the .package file(s) from the .rar or .zip file(s).2. Cut and paste the .package file(s) into your Mods folderWindows XP: Documents and Settings\\(Current User Account)\\My Documents\\Electronic Arts\\The Sims 4\\Mods\\Windows Vista/7/8/8.1: Users\\(Current User Account)\\Documents\\Electronic Arts\\The Sims 4\\Mods\\\n\n Need more information?Anyone can use both .rar and .zip files easily! On Windows, use WinRAR.If you don't have a Mods folder, just make one.Mod still not working? Make sure you have script mods enabled\n\n\n\n\n\n\n\n\n\n\n\n \n\n\n\n\n\n\n\n\n\nSearch\nAdvanced Search\n\n\n\n\nBack to download view\n\n\n6 Comments / Replies (Who?)\n- 4 Feedback Posts,\n1 Thanks Posts\nHide Thanks Posts for this thread (Show only feedback)"
stop_words = set();

def split_desc_to_words(desc):
  res = "";

  try:
    res = re.sub(r"(([^a-zA-Z])+(')([^a-zA-Z])+|([^a-zA-Z])+(')|(')([^a-zA-Z])+|[^a-zA-Z']+)", " ", desc);
    res = re.sub(r"\\s+", " ", res);
    res = re.sub(r"(^(\\s+)|(\\s+)$)", "", res);
    res = wnl.lemmatize(res.lower());
  except:
    pass;

  return list(map(lambda x: wnl.lemmatize(x), res.split(" ")));

def clean_word(word):
  res = "";

  try:
    res = re.sub(r"(([^a-zA-Z])+(')([^a-zA-Z])+|([^a-zA-Z])+(')|(')([^a-zA-Z])+|[^a-zA-Z']+)", " ", word);
    res = re.sub(r"\\s+", " ", res);
    res = re.sub(r"(^(\\s+)|(\\s+)$)", "", res);
    res = res.lower().strip();
  except:
    pass;


  return list(map(lambda x: wnl.lemmatize(x), res.split(" ")));

# read from in put and build a set of stopwords
def build_stop_words_set():
  src = open('stop_words', 'r');

  for line in src:
      stopword = line.rstrip('\n');
      stop_words.add(stopword);

  src.close()
  return;

def generate_ngram_keywords(keywords, mult, final_ngrams):
  ngram_words = {};

  # one gram
  for i in range(0, len(keywords)):

    if (len(keywords[i]) <= 2):
      continue;

    if keywords[i] in stop_words:
      continue;

    # ignore one gram if its two gram is in stop words
    if (i < len(keywords)-1):
      two_gram_test = keywords[i] + ' ' + keywords[i+1];
      if two_gram_test in stop_words:
        continue;

    if (keywords[i] in ngram_words):
      ngram_words[keywords[i]] += mult;
    else:
      ngram_words[keywords[i]] = mult;


  # two gram
  for i in range(0, len(keywords)-1):
    if (len(keywords[i]) <= 2 or len(keywords[i+1]) <= 2):
      continue;

    if (keywords[i] in stop_words or keywords[i+1] in stop_words):
      continue;
    two_gram_word = keywords[i] + ' ' + keywords[i+1];

    if (two_gram_word in stop_words):
      continue;

    if (two_gram_word in ngram_words):
      ngram_words[two_gram_word] += mult;
    else:
      ngram_words[two_gram_word] = mult;


  # three gram
  for i in range(0, len(keywords)-2):
    if (len(keywords[i]) <= 2 or len(keywords[i+1]) <= 2 or len(keywords[i+2]) <= 2):
      continue;

    if (keywords[i] in stop_words or keywords[i+1] in stop_words or keywords[i+2] in stop_words):
      continue;
    three_gram_word = keywords[i] + ' ' + keywords[i+1] + ' ' +keywords[i+2];

    if (three_gram_word in stop_words):
      continue;

    if (three_gram_word in ngram_words):
      ngram_words[three_gram_word] += mult;
    else:
      ngram_words[three_gram_word] = mult;

  # remove the ones that only appeared 1 time
  for key, value in ngram_words.items():
    if value >= 2:
      final_ngrams[key] = value;

  return; 

def generate_ngram_keywords_for_doc(doc):
  final_ngrams = {};
  if (len(stop_words) == 0):
    build_stop_words_set();

  generate_ngram_keywords_from_desc(doc['description'], final_ngrams);
  generate_ngram_keywords_from_title(doc['title'], final_ngrams);
  generate_ngram_keywords_from_word_array(doc['tags'], final_ngrams);
  generate_ngram_keywords_from_word_array(doc['types'], final_ngrams);

  # for key in list(final_ngrams.keys()):
  #   plural_1 = key + 's';
  #   plural_2 = key + 'es';
  #   if plural_1 in final_ngrams:
  #     final_ngrams[key] += final_ngrams[plural_1]
  #     final_ngrams.pop(plural_1, None);

  #   if plural_2 in final_ngrams:
  #     final_ngrams[key] += final_ngrams[plural_2]
  #     final_ngrams.pop(plural_2, None);


  f_ngrams = OrderedDict(sorted(final_ngrams.items(), key=lambda x : x[1], reverse=True));

  return f_ngrams;

def generate_ngram_keywords_from_desc(desc, final_ngrams):
  if (len(stop_words) == 0):
    build_stop_words_set();

  words = split_desc_to_words(desc);
  generate_ngram_keywords(words, 1, final_ngrams);

  return;

def generate_ngram_keywords_from_title(title, final_ngrams):
  if (len(stop_words) == 0):
    build_stop_words_set();

  words = split_desc_to_words(title);
  generate_ngram_keywords(words, 5, final_ngrams);

  return;

def generate_ngram_keywords_from_word_array(types, final_ngrams):
  if (len(stop_words) == 0):
    build_stop_words_set();

  words = [];
  if types is None:
    return;
  
  for t in types:
    words = words + clean_word(t);

  generate_ngram_keywords(words, 5, final_ngrams);

  return;

if __name__ == "__main__":
  build_stop_words_set();
  keywords = split_desc_to_words(desc);
  final_ngrams = {};
  generate_ngram_keywords(keywords, 1, final_ngrams);
